---
- name: (Debian) Refresh package cache
  ansible.builtin.apt:
    cache_valid_time: 3600
  environment:
    https_proxy: "{{ zabbix_http_proxy }}"
  when: gitlab_runner_skip_package_repo_install is not defined or not gitlab_runner_skip_package_repo_install

- name: (Debian) Get Gitlab repository installation script
  get_url:
    url: "https://packages.gitlab.com/install/repositories/runner/{{ gitlab_runner_package_name }}/script.deb.sh"
    dest: /tmp/gitlab-runner.script.deb.sh
    mode: 0744
  environment:
    https_proxy: "{{ zabbix_http_proxy }}"
  when: gitlab_runner_skip_package_repo_install is not defined or not gitlab_runner_skip_package_repo_install

- name: (Debian) Install Gitlab repository
  command: bash /tmp/gitlab-runner.script.deb.sh
  args:
    creates: "/etc/apt/sources.list.d/runner_{{ gitlab_runner_package_name }}.list"
  become: true
  environment:
    https_proxy: "{{ zabbix_http_proxy }}"
  when: gitlab_runner_skip_package_repo_install is not defined or not gitlab_runner_skip_package_repo_install

- name: (Debian) Update gitlab_runner_package_name
  set_fact:
    gitlab_runner_package: "{{ gitlab_runner_package_name }}={{ debian_gitlab_runner_package_version }}"
    gitlab_runner_package_state: "present"
  when: gitlab_runner_package_version is defined

- name: (Debian) Set gitlab_runner_package_name
  set_fact:
    gitlab_runner_package: "{{ gitlab_runner_package_name }}"
    gitlab_runner_package_state: "latest"
  when: gitlab_runner_package_version is not defined

- name: (Debian) Install GitLab Runner
  apt:
    name: "{{ gitlab_runner_package }}"
    state: "{{ gitlab_runner_package_state }}"
    update_cache: true
  environment:
    https_proxy: "{{ zabbix_http_proxy }}"
    GITLAB_RUNNER_DISABLE_SKEL: "true"
  notify: restart gitlab-runner
  when: ansible_distribution_release in ["buster", "focal", "jammy"]

- name: (Debian) Install GitLab Runner
  apt:
    name: "{{ gitlab_runner_package }}"
    state: "{{ gitlab_runner_package_state }}"
    allow_downgrade: true
  environment:
    https_proxy: "{{ zabbix_http_proxy }}"
  when: ansible_distribution_release not in ["buster", "focal", "jammy"]